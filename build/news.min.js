/*! news 2014-03-14 */
var app=angular.module("topnews",["ngRoute"]);app.config(function($routeProvider){$routeProvider.when("/",{templateUrl:"/views/orgs.html",controller:"OrgController"}).when("/:org_id/:org_name",{templateUrl:"/views/feeds.html",controller:"FeedsController"}).when("/:org_id/article/show",{templateUrl:"/views/article.html",controller:"ArticleController"})}),app.controller("AppController",function(){$(".view-container").height($(window).height()-$(".site-header").height())});var app=angular.module("topnews");app.controller("ArticleController",function($scope,$routeParams,$sce,ArticleFactory){$(".view-container").css("max-height",$(window).height()-$(".site-header").height()-34+"px"),$(".view-container").css("height",$(window).height()-$(".site-header").height()-34+"px"),$scope.org_id=$routeParams.org_id,$scope.article=ArticleFactory.getCurrentArticle(),$scope.article&&$scope.article.link?($scope.url=$sce.trustAsResourceUrl($scope.article.link+"&output=embed"),$scope.feedback={bias:5,relevance:5,quality:5},$scope.submit=function(){$scope.article.mediaGroups||($scope.article.mediaGroups=""),ArticleFactory.submitFeedback($scope.feedback,$scope.article,$scope.org_id,function(){window.history.back()})},$scope.toggle=function($event){$($event.target).hasClass("expanded")?($($event.target).removeClass("expanded"),$("form.dropdown").removeClass("visible")):($($event.target).addClass("expanded"),$("form.dropdown").addClass("visible"))}):window.location="/#/"});var app=angular.module("topnews");app.controller("FeedsController",function($scope,$routeParams,FeedsFactory,ArticleFactory){$scope.org_id=$routeParams.org_id,$scope.org_name=$routeParams.org_name,$scope.expandedFeed=null,$scope.selectedIndex=null,$scope.isReturn=!1,$scope.loadFeeds=function(org_id){FeedsFactory.read(org_id,function(data){$scope.feeds=data;var selectedFeed=FeedsFactory.getSelectedFeed();selectedFeed&&angular.forEach(data,function(feed,index){feed.feed_id===selectedFeed.feed_id&&($scope.selectedIndex=index,setTimeout(function(){$($("header.collapsed")[$scope.selectedIndex]).trigger("click")},500),$scope.isReturn=!0)})})},$scope.loadRSS=function(feed,$event){var $target=$($event.currentTarget);$target.hasClass("expanded")?($target.removeClass("expanded"),$target.addClass("collapsed"),$scope.expandedFeed=null,feed.articles=[]):(null!==$scope.expandedFeed&&($("header.expanded").addClass("collapsed"),$("header.expanded").removeClass("expanded"),$scope.expandedFeed.articles=[]),$target.removeClass("collapsed"),$target.addClass("expanded"),FeedsFactory.setSelectedFeed(feed),feed.articles=FeedsFactory.loadFeeds(feed.feed_url,function(data){if(feed.articles=data,angular.forEach(feed.articles,function(article){article.publishedDate=new Date(article.publishedDate)}),$scope.expandedFeed=feed,$scope.isReturn){var selectedArticle=ArticleFactory.getCurrentArticle();angular.forEach(feed.articles,function(article,index){article.link===selectedArticle.link&&setTimeout(function(){$("html, body").animate({scrollTop:$($("a.article")[index]).offset().top},500)},500)}),$scope.isReturn=!1}}))},$scope.setCurrentArticle=function(article){ArticleFactory.setCurrentArticle(article),window.location="/#/"+$scope.org_id+"/article/show"},$scope.loadFeeds($scope.org_id)});var app=angular.module("topnews");app.controller("OrgController",function($scope,OrgFactory,ArticleFactory){$scope.orgs=[],$scope.articles=[],$scope.sortBy="avgRank",$scope.loadOrgs=function(){OrgFactory.read(function(data){$scope.orgs=data})},$scope.loadArticles=function(){ArticleFactory.loadArticles(function(data){$scope.articles=data,angular.forEach($scope.articles,function(article){article.mediaGroups=JSON.parse(article.mediaGroups);var match=article.publishedDate.match(/^(\d+)-(\d+)-(\d+) (\d+)\:(\d+)\:(\d+)$/);article.publishedDate=new Date(match[1],match[2]-1,match[3],match[4],match[5],match[6])})})},$scope.toggle=function($event,section){$(".toggle button.selected").removeClass("selected"),$($event.target).addClass("selected"),$("section.toggle").hide(),$("#"+section).show()},$scope.setCurrentArticle=function(article){ArticleFactory.setCurrentArticle(article),window.location="/#/"+article.org_id+"/article/show"},$scope.loadOrgs(),$scope.loadArticles()});var app=angular.module("topnews");app.factory("ArticleFactory",function($http){var currentArticle=null;return{setCurrentArticle:function(article){currentArticle=article},getCurrentArticle:function(){return currentArticle},loadArticles:function(callback){$http.get("server/request.php?action=loadArticles").success(callback)},submitFeedback:function(feedback,article,org_id,callback){$http.post("server/request.php?action=submitFeedback",{feedback:feedback,article:article,org_id:org_id}).success(callback)}}});var app=angular.module("topnews");app.factory("FeedsFactory",function($http){var selectedFeed=null;return{setSelectedFeed:function(feed){selectedFeed=feed},getSelectedFeed:function(){return selectedFeed},read:function(org_id,callback){$http.post("server/request.php?action=readFeeds",{org_id:org_id}).success(callback)},loadFeeds:function(url,callback){$http.jsonp("//ajax.googleapis.com/ajax/services/feed/load?v=1.0&num=50&callback=JSON_CALLBACK&q="+encodeURIComponent(url)).then(function(response){callback(response.data.responseData.feed.entries)})}}});var app=angular.module("topnews");app.factory("OrgFactory",function($http){return{read:function(callback){$http.get("server/request.php?action=readOrgs").success(callback)}}});