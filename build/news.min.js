/*! news 2014-03-20 */
var app=angular.module("topnews",["ngRoute"]);app.config(function($routeProvider,$locationProvider){$locationProvider.hashPrefix("!"),$routeProvider.when("/",{templateUrl:"/views/orgs.html",controller:"OrgController"}).when("/org",{templateUrl:"/views/feeds.html",controller:"FeedsController"}).when("/article",{templateUrl:"/views/article.html",controller:"ArticleController"}).when("/article/:article_id",{templateUrl:"/views/article.html",controller:"ArticleController"})}),app.controller("AppController",function($scope){$scope.openSocial=function(url){window.open(url,"_blank","modal=yes")}});var app=angular.module("topnews");app.controller("ArticleController",function($scope,$routeParams,$sce,OrgFactory,ArticleFactory,MobileFactory){MobileFactory.isIos()||($(".view-container").css("max-height",$(window).height()-$(".site-header").height()+"px"),$(".view-container").css("height",$(window).height()-$(".site-header").height()+"px")),$scope.renderPage=function(){$scope.org_id=OrgFactory.getCurrentOrg().org_id,$scope.article=ArticleFactory.getCurrentArticle(),$scope.article&&$scope.article.link?($scope.url=$sce.trustAsResourceUrl($scope.article.link),$scope.feedback={bias:5,relevance:5,quality:5}):window.location="/#/"},$routeParams.article_id?ArticleFactory.loadArticle($routeParams.article_id,function(data){ArticleFactory.setCurrentArticle(data[0]),OrgFactory.loadOrg($routeParams.article_id,function(data){OrgFactory.setCurrentOrg(data[0]),$scope.renderPage()})}):$scope.renderPage(),$scope.submit=function(){$scope.article.mediaGroups||($scope.article.mediaGroups=""),ArticleFactory.submitFeedback($scope.feedback,$scope.article.article_id,$scope.org_id,function(){window.location="#!/org"})},$scope.toggle=function($event){$($event.target).hasClass("expanded")?($($event.target).removeClass("expanded"),$("form.dropdown").removeClass("visible")):($($event.target).addClass("expanded"),$("form.dropdown").addClass("visible"))}});var app=angular.module("topnews");app.controller("FeedsController",function($scope,$routeParams,OrgFactory,FeedsFactory,ArticleFactory){$scope.org=OrgFactory.getCurrentOrg(),$scope.org||window.history.back(),$scope.expandedFeed=null,$scope.selectedIndex=null,$scope.isReturn=!1,$scope.loadFeeds=function(org_id){FeedsFactory.read(org_id,function(data){$scope.feeds=data;var selectedFeed=FeedsFactory.getCurrentFeed(),found=!1;selectedFeed?(angular.forEach(data,function(feed,index){feed.feed_id===selectedFeed.feed_id&&($scope.selectedIndex=index,found=!0,setTimeout(function(){$($("header.collapsed")[$scope.selectedIndex]).trigger("click")},500),$scope.isReturn=!0)}),found||setTimeout(function(){$($("header.collapsed")[0]).trigger("click")},500)):setTimeout(function(){$($("header.collapsed")[0]).trigger("click")},500)})},$scope.loadRSS=function(feed,$event){var $target=$($event.currentTarget);$target.hasClass("expanded")?($target.removeClass("expanded"),$target.addClass("collapsed"),$target.siblings().hide(),$scope.expandedFeed=null,feed.articles=[]):(null!==$scope.expandedFeed&&($("header.expanded").addClass("collapsed"),$("header.expanded").siblings().hide(),$("header.expanded").removeClass("expanded"),$scope.expandedFeed.articles=[]),$target.removeClass("collapsed"),$target.addClass("expanded"),$target.siblings().show(),FeedsFactory.setCurrentFeed(feed),feed.articles=FeedsFactory.loadFeeds(feed.feed_url,function(data){if(feed.articles=data,angular.forEach(feed.articles,function(article){article.publishedDate=new Date(article.publishedDate),article.fullTitle=article.title,article.title.length>40&&(article.title=article.title.substr(0,40)+"..."),article.contentSnippet.length>90&&(article.contentSnippet=article.contentSnippet.substr(0,90)+"...")}),$scope.expandedFeed=feed,$scope.isReturn){var selectedArticle=ArticleFactory.getCurrentArticle();angular.forEach(feed.articles,function(article,index){article.link===selectedArticle.link&&setTimeout(function(){$("html, body").animate({scrollTop:$($("a.article")[index]).offset().top},500)},500)}),$scope.isReturn=!1}}))},$scope.getThumb=function(article){var mediaGroupContents=article.mediaGroups[0].contents[0],url="",width=null;return mediaGroupContents.thumbnails?url=mediaGroupContents.thumbnails[0].url:angular.forEach(article.mediaGroups[0].contents,function(media){media.width&&(!width||media.width<width)&&(width=media.width,url=media.url)}),url},$scope.setCurrentArticle=function(article,feed){article.mediaGroups||(article.mediaGroups=""),article.category_id=feed.category_id,ArticleFactory.submitArticle(article,$scope.org.org_id,feed.feed_id,function(data){article.article_id=data[0].article_id,ArticleFactory.setCurrentArticle(article),$scope.redirect("#!/article/"+data[0].article_id)})},$scope.redirect=function(location){window.location=location},$scope.loadFeeds($scope.org.org_id)});var app=angular.module("topnews");app.controller("OrgController",function($scope,$location,OrgFactory,ArticleFactory){$scope.orgs=[],$scope.articles=[],$scope.categories=[],$scope.sortBy="avgRank",$scope.location=$location,$scope.sortDirection=function(){var isASC=!0;return"bias"===$scope.sortBy&&(isASC=!1),isASC},$scope.loadOrgs=function(){OrgFactory.read(function(data){$scope.orgs=data})},$scope.loadArticles=function(){ArticleFactory.loadArticles(function(data){$scope.articles=data,angular.forEach($scope.articles,function(article){article.mediaGroups=JSON.parse(article.mediaGroups),-1===$scope.categories.indexOf(article.category_name)&&$scope.categories.push(article.category_name);var match=article.publishedDate.match(/^(\d+)-(\d+)-(\d+) (\d+)\:(\d+)\:(\d+)$/);article.publishedDate=new Date(match[1],match[2]-1,match[3],match[4],match[5],match[6])}),setTimeout(function(){$($("header.collapsed")[0]).trigger("click")},500)})},$scope.toggleCategory=function($event){$target=$($event.currentTarget),$target.hasClass("expanded")?($target.removeClass("expanded"),$target.addClass("collapsed"),$target.siblings().hide()):($("header.expanded").length>0&&($("header.expanded").addClass("collapsed"),$("header.expanded").siblings().hide(),$("header.expanded").removeClass("expanded")),$target.removeClass("collapsed"),$target.addClass("expanded"),$target.siblings().show())},$scope.toggle=function($event,section){$(".toggle button.selected").removeClass("selected"),$($event.target).addClass("selected"),$("section.toggle").hide(),$("#"+section).show()},$scope.setCurrentArticle=function(article){ArticleFactory.setCurrentArticle(article),window.location="/#!/article/"+article.article_id},$scope.setCurrentOrg=function(org){OrgFactory.setCurrentOrg(org),window.location="#!/org"},$scope.getRank=function(article){var value=article[$scope.sortBy],result=Math.round(10*value)/10;return 0===result?"-":result},$scope.loadOrgs(),$scope.loadArticles()});var app=angular.module("topnews");app.factory("ArticleFactory",function($http){return{setCurrentArticle:function(article){window.localStorage.setItem("currentArticle",JSON.stringify(article))},getCurrentArticle:function(){return JSON.parse(window.localStorage.getItem("currentArticle"))},loadArticle:function(article_id,callback){$http.post("server/request.php?action=loadArticle",{article_id:article_id}).success(callback)},loadArticles:function(callback){$http.get("server/request.php?action=loadArticles").success(callback)},submitArticle:function(article,org_id,feed_id,callback){$http.post("server/request.php?action=submitArticle",{article:article,org_id:org_id,feed_id:feed_id}).success(callback)},submitFeedback:function(feedback,article_id,org_id,callback){$http.post("server/request.php?action=submitFeedback",{feedback:feedback,article_id:article_id,org_id:org_id}).success(callback)}}});var app=angular.module("topnews");app.factory("FeedsFactory",function($http){return{setCurrentFeed:function(feed){window.localStorage.setItem("currentFeed",JSON.stringify(feed))},getCurrentFeed:function(){return JSON.parse(window.localStorage.getItem("currentFeed"))},read:function(org_id,callback){$http.post("../server/request.php?action=readFeeds",{org_id:org_id}).success(callback)},loadFeeds:function(url,callback){$http.jsonp("//ajax.googleapis.com/ajax/services/feed/load?v=1.0&num=50&callback=JSON_CALLBACK&q="+encodeURIComponent(url)).then(function(response){callback(response.data.responseData.feed.entries)})}}});var app=angular.module("topnews");app.factory("MobileFactory",function(){return{isMobile:function(){return null!==(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/iPhone|iPad|iPod/i)||navigator.userAgent.match(/Opera Mini/i)||navigator.userAgent.match(/IEMobile/i))},isIos:function(){return null!==navigator.userAgent.match(/iPhone|iPad|iPod/i)}}});var app=angular.module("topnews");app.factory("OrgFactory",function($http){return{setCurrentOrg:function(org){window.localStorage.setItem("currentOrg",JSON.stringify(org))},getCurrentOrg:function(){return JSON.parse(window.localStorage.getItem("currentOrg"))},loadOrg:function(article_id,callback){$http.post("server/request.php?action=loadOrg",{article_id:article_id}).success(callback)},read:function(callback){$http.get("server/request.php?action=readOrgs").success(callback)}}}),function(){var po=document.createElement("script");po.type="text/javascript",po.async=!0,po.src="https://apis.google.com/js/platform.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(po,s)}(),function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];d.getElementById(id)||(js=d.createElement(s),js.id=id,js.src="//connect.facebook.net/en_US/all.js#xfbml=1",fjs.parentNode.insertBefore(js,fjs))}(document,"script","facebook-jssdk"),!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?"http":"https";d.getElementById(id)||(js=d.createElement(s),js.id=id,js.src=p+"://platform.twitter.com/widgets.js",fjs.parentNode.insertBefore(js,fjs))}(document,"script","twitter-wjs");