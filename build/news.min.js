/*! news 2014-03-26 */
var app=angular.module("topnews",["ngRoute","ngTouch"]);app.config(function($routeProvider){$routeProvider.when("/",{templateUrl:"/views/orgs.html",controller:"OrgController",title:"Home"}).when("/home/:toggle",{templateUrl:"/views/orgs.html",controller:"OrgController",title:"Home"}).when("/org",{templateUrl:"/views/feeds.html",controller:"FeedsController",title:"RSS Feed"}).when("/article",{templateUrl:"/views/article.html",controller:"ArticleController",title:"Article"}).when("/article/:article_id",{templateUrl:"/views/article.html",controller:"ArticleController",title:"Article"})}),app.controller("AppController",function($scope,BreadcrumbFactory,MobileFactory){$scope.breadcrumbs=[],$scope.$on("$routeChangeSuccess",function(){BreadcrumbFactory.setUrl(window.location.hash),$scope.breadcrumbs=BreadcrumbFactory.getBreadCrumb()}),$scope.openSocial=function(url){window.open(url,"_blank","modal=yes")},$scope.isIos=function(){return MobileFactory.isIos()},$scope.navigate=function(direction){"back"===direction?history.back():history.forward()}});var app=angular.module("topnews");app.controller("ArticleController",function($scope,$routeParams,$sce,OrgFactory,ArticleFactory,MobileFactory){MobileFactory.isIos()||($(".view-container").css("max-height",$(window).height()-$(".site-header").height()-48+"px"),$(".view-container").css("height",$(window).height()-$(".site-header").height()-48+"px")),$scope.renderPage=function(){$scope.org_id=OrgFactory.getCurrentOrg().org_id,$scope.article=ArticleFactory.getCurrentArticle(),$scope.article&&$scope.article.link?($scope.url=$sce.trustAsResourceUrl($scope.article.link),$scope.feedback={bias:5,relevance:5,quality:5}):window.location="/#/"},$routeParams.article_id?ArticleFactory.loadArticle($routeParams.article_id,function(data){ArticleFactory.setCurrentArticle(data[0]),OrgFactory.loadOrg($routeParams.article_id,function(data){OrgFactory.setCurrentOrg(data[0]),$scope.renderPage()})}):$scope.renderPage(),$scope.submit=function(){$scope.article.mediaGroups||($scope.article.mediaGroups=""),ArticleFactory.submitFeedback($scope.feedback,$scope.article.article_id,$scope.org_id,function(){setTimeout(function(){$("button.menu").trigger("click"),$(".modal").show()},500)})},$scope.toggle=function($event){$($event.target).hasClass("expanded")?($($event.target).removeClass("expanded"),$("form.dropdown").removeClass("visible")):($($event.target).addClass("expanded"),$("form.dropdown").addClass("visible"))},$scope.mbActionClick=function(key){"back"===key?window.location="#/org":$(".modal").hide()},$scope.getCurrentUrl=function(encode){var result,url="http://www.newzrank.com/"+window.location.hash;return result=encode?encodeURIComponent(url):url,console.log(result),result},$scope.openSocial=function(url){console.log(url),window.open(url,"_blank","modal=yes")},$scope.isIos=function(){return MobileFactory.isIos()}});var app=angular.module("topnews");app.controller("FeedsController",function($scope,$routeParams,OrgFactory,FeedsFactory,ArticleFactory){$scope.org=OrgFactory.getCurrentOrg(),$scope.org||window.history.back(),$scope.expandedFeed=null,$scope.selectedIndex=null,$scope.loadFeeds=function(org_id){FeedsFactory.read(org_id,function(data){$scope.feeds=data;var selectedFeed=FeedsFactory.getCurrentFeed(),found=!1;selectedFeed?(angular.forEach(data,function(feed,index){feed.feed_id===selectedFeed.feed_id&&($scope.selectedIndex=index,found=!0,setTimeout(function(){$($("header.collapsed")[$scope.selectedIndex]).trigger("click")},500))}),found||setTimeout(function(){$($("header.collapsed")[0]).trigger("click")},500)):setTimeout(function(){$($("header.collapsed")[0]).trigger("click")},500)})},$scope.loadRSS=function(feed,$event){var $target=$($event.currentTarget);$target.hasClass("expanded")?($target.removeClass("expanded"),$target.addClass("collapsed"),$target.siblings().hide(),$scope.expandedFeed=null,feed.articles=[]):(null!==$scope.expandedFeed&&($("header.expanded").addClass("collapsed"),$("header.expanded").siblings().hide(),$("header.expanded").removeClass("expanded"),$scope.expandedFeed.articles=[]),$target.removeClass("collapsed"),$target.addClass("expanded"),$target.siblings().show(),FeedsFactory.setCurrentFeed(feed),feed.articles=FeedsFactory.loadFeeds(feed.feed_url,function(data){feed.articles=data,angular.forEach(feed.articles,function(article){article.publishedDate=new Date(article.publishedDate),article.fullTitle=article.title,article.title.length>40&&(article.title=article.title.substr(0,40)+"..."),article.contentSnippet.length>90&&(article.contentSnippet=article.contentSnippet.substr(0,90)+"...")}),$scope.expandedFeed=feed;var selectedArticle=ArticleFactory.getCurrentArticle();selectedArticle&&angular.forEach(feed.articles,function(article,index){article.link===selectedArticle.link&&setTimeout(function(){$("html, body").animate({scrollTop:$($("a.article")[index]).offset().top},500)},500),ArticleFactory.setCurrentArticle(null)})}))},$scope.getThumb=function(article){var mediaGroupContents=article.mediaGroups[0].contents[0],url="",width=null;return mediaGroupContents.thumbnails?url=mediaGroupContents.thumbnails[0].url:angular.forEach(article.mediaGroups[0].contents,function(media){media.width&&(!width||media.width<width)&&(width=media.width,url=media.url)}),url},$scope.setCurrentArticle=function(article,feed){article.mediaGroups||(article.mediaGroups=""),article.category_id=feed.category_id,ArticleFactory.submitArticle(article,$scope.org.org_id,feed.feed_id,function(data){article.article_id=data[0].article_id,ArticleFactory.setCurrentArticle(article),$scope.redirect("#/article/"+data[0].article_id)})},$scope.redirect=function(location){window.location=location},$scope.loadFeeds($scope.org.org_id)});var app=angular.module("topnews");app.controller("OrgController",function($scope,$routeParams,$location,OrgFactory,ArticleFactory,MobileFactory){$scope.orgs=[],$scope.articles=[],$scope.categories=[],$scope.selectedCategories=[],$scope.sortBy="avgRank",$scope.selectedCategory="Business",$scope.isSelectedCategory=function(category){var value=!1;return-1!==$scope.selectedCategories.indexOf(category)&&(value=!0),value},$scope.goToSelectedCategory=function(){setTimeout(function(){$("."+$scope.selectedCategory).trigger("click"),$("html, body").animate({scrollTop:$("."+$scope.selectedCategory).offset().top},500)},500)},$scope.updateSelectedCategories=function($event){$check=$($event.currentTarget),"checked"===$check.attr("checked")&&-1!==$scope.selectedCategories.indexOf($check.attr("id"))?$scope.selectedCategories.splice($scope.selectedCategories.indexOf($check.attr("id")),1):$scope.selectedCategories.push($check.attr("id")),$scope.selectedCategories.sort(),OrgFactory.setCurrentCategories($scope.selectedCategories)},$scope.sortDirection=function(){var isASC=!0;return"bias"===$scope.sortBy&&(isASC=!1),isASC},$scope.toggleOptions=function($event){var $element=$($event.currentTarget),$options=$("."+$element.attr("rel"));$options.css("top",$($event.currentTarget).offset().top+50),MobileFactory.isMobile()?$options.css("left",$($event.currentTarget).offset().left-$options.width()+25):$options.css("left",$($event.currentTarget).offset().left-$options.width()+20),$element.hasClass("active")?($element.removeClass("active"),$options.removeClass("visible"),$options.addClass("hidden")):($element.addClass("active"),$options.addClass("visible"),$options.removeClass("hidden"))},$scope.loadOrgs=function(){OrgFactory.read(function(data){$scope.orgs=data})},$scope.loadArticles=function(){ArticleFactory.loadArticles(function(data){if($scope.articles=data,0===$scope.articles.length)setTimeout(function(){$(".toolbar .toggle .org").trigger("click")},500);else{var selectedArticle=ArticleFactory.getCurrentArticle(),prevCategories=OrgFactory.getCurrentCategories();angular.forEach($scope.articles,function(article,index){article.mediaGroups=JSON.parse(article.mediaGroups),-1===$scope.categories.indexOf(article.category_name)&&($scope.categories.push(article.category_name),$scope.selectedCategories.push(article.category_name));var match=article.publishedDate.match(/^(\d+)-(\d+)-(\d+) (\d+)\:(\d+)\:(\d+)$/);article.publishedDate=new Date(match[1],match[2]-1,match[3],match[4],match[5],match[6]),selectedArticle&&article.link===selectedArticle.link&&setTimeout(function(){$("html, body").animate({scrollTop:$($("a.article")[index]).offset().top},500),ArticleFactory.setCurrentArticle(null)},1e3)}),prevCategories&&($scope.selectedCategories=prevCategories),setTimeout(function(){$($("header.collapsed")[0]).trigger("click")},500)}})},$scope.toggleCategory=function($event){$target=$($event.currentTarget),$target.hasClass("expanded")?($target.removeClass("expanded"),$target.addClass("collapsed"),$target.siblings().hide()):($("header.expanded").length>0&&($("header.expanded").addClass("collapsed"),$("header.expanded").siblings().hide(),$("header.expanded").removeClass("expanded")),$target.removeClass("collapsed"),$target.addClass("expanded"),$target.siblings().show())},$scope.toggle=function($event,section){$event.preventDefault(),$(".toggle button.selected").removeClass("selected");var hash="home/"+$($event.target).attr("class");window.location.hash!==hash&&$location.path(hash).replace(),$($event.target).addClass("selected"),$("section.toggle").hide(),$("#"+section).show()},$scope.setCurrentArticle=function(article){ArticleFactory.setCurrentArticle(article),window.location="/#/article/"+article.article_id},$scope.setCurrentOrg=function(org){OrgFactory.setCurrentOrg(org),window.location="#/org"},$scope.getRank=function(article){var value=article[$scope.sortBy],result=Math.round(10*value)/10;return 0===result?"-":result},$scope.loadOrgs(),$scope.loadArticles(),$routeParams.toggle&&setTimeout(function(){$("button."+$routeParams.toggle).trigger("click")},500)});var app=angular.module("topnews");app.factory("ArticleFactory",function($http){return{setCurrentArticle:function(article){null===article?window.localStorage.removeItem("currentArticle"):window.localStorage.setItem("currentArticle",JSON.stringify(article))},getCurrentArticle:function(){var article=!1;return"null"!==window.localStorage.getItem("currentArticle")&&(article=JSON.parse(window.localStorage.getItem("currentArticle"))),article},loadArticle:function(article_id,callback){$http.post("server/request.php?action=loadArticle",{article_id:article_id}).success(callback)},loadArticles:function(callback){$http.get("server/request.php?action=loadArticles").success(callback)},submitArticle:function(article,org_id,feed_id,callback){$http.post("server/request.php?action=submitArticle",{article:article,org_id:org_id,feed_id:feed_id}).success(callback)},submitFeedback:function(feedback,article_id,org_id,callback){$http.post("server/request.php?action=submitFeedback",{feedback:feedback,article_id:article_id,org_id:org_id}).success(callback)}}});var app=angular.module("topnews");app.factory("BreadcrumbFactory",function(){var history={home:{active:!0,url:"/#/",origUrl:"/#/",title:"Home",order:0},org:{active:!1,url:"/#/feed",origUrl:"/#/feed",title:"RSS Feed",order:1},article:{active:!1,url:"/#/article",origUrl:"/#/article",title:"Article",order:2}};return{setUrl:function(url){var urlPart=url.split("/"),key=""===urlPart[1]?"home":urlPart[1],order=history[key].order;history[key].url=url,history[key].active=!0,angular.forEach(history,function(history){history.order>order&&(history.active=!1)})},getBreadCrumb:function(){var breadcrumbs=[{url:history.home.url,title:history.home.title}];return history.org.active&&breadcrumbs.push({url:history.org.url,title:history.org.title}),history.article.active&&breadcrumbs.push({url:history.article.url,title:history.article.title}),breadcrumbs}}});var app=angular.module("topnews");app.factory("FeedsFactory",function($http){return{setCurrentFeed:function(feed){window.localStorage.setItem("currentFeed",JSON.stringify(feed))},getCurrentFeed:function(){return JSON.parse(window.localStorage.getItem("currentFeed"))},read:function(org_id,callback){$http.post("../server/request.php?action=readFeeds",{org_id:org_id}).success(callback)},loadFeeds:function(url,callback){$http.jsonp("//ajax.googleapis.com/ajax/services/feed/load?v=1.0&num=50&callback=JSON_CALLBACK&q="+encodeURIComponent(url)).then(function(response){callback(response.data.responseData.feed.entries)})}}});var app=angular.module("topnews");app.factory("MobileFactory",function(){return{isMobile:function(){return null!==(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/iPhone|iPad|iPod/i)||navigator.userAgent.match(/Opera Mini/i)||navigator.userAgent.match(/IEMobile/i))},isIos:function(){return null!==navigator.userAgent.match(/iPhone|iPad|iPod/i)}}});var app=angular.module("topnews");app.factory("OrgFactory",function($http){return{setCurrentOrg:function(org){window.localStorage.setItem("currentOrg",JSON.stringify(org))},getCurrentOrg:function(){return JSON.parse(window.localStorage.getItem("currentOrg"))},setCurrentCategories:function(categories){window.localStorage.setItem("currentCategories",JSON.stringify(categories))},getCurrentCategories:function(){return JSON.parse(window.localStorage.getItem("currentCategories"))},loadOrg:function(article_id,callback){$http.post("server/request.php?action=loadOrg",{article_id:article_id}).success(callback)},read:function(callback){$http.get("server/request.php?action=readOrgs").success(callback)}}});